<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Booksy - Club de Lectura</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap" rel="stylesheet">
</head>
<body class="main-body">
    <header class="main-header">
        <img src="../images/BooksyLogo.png" class="BooksyLogo" alt="Booksy Logo" style="width: 180px; max-width: 30vw; filter: drop-shadow(0 2px 8px #2c5a9140);">
        <nav class="main-nav">
            <div class="profile-dropdown">
                <button class="profile-btn" id="profileDropdownBtn">
                    <span id="usernameDisplay">Tu perfil</span>
                    <svg width="24" height="24" fill="none" stroke="#2c5a91" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="8" r="4"/>
                        <path d="M4 20c0-4 8-4 8-4s8 0 8 4"/>
                    </svg>
                    <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 16 16">
                        <path d="M4 6l4 4 4-4" stroke="#2c5a91" stroke-width="2" fill="none"/>
                    </svg>
                </button>
                <div class="dropdown-content" id="profileDropdownContent">
                    <a href="perfil.html">Editar perfil</a>
                    <a href="#" onclick="logout()">Cerrar sesi贸n</a>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <!-- Secci贸n Mis Clubes -->
        <section class="mis-clubes-section">
            <h2>Mis Clubes</h2>
            <div class="mis-clubes-grid"></div>
        </section>

        <!-- Secci贸n Todos los Clubes -->
        <section class="main-sections">
            <h2>Clubes de Lectura</h2>
            <div style="text-align:center; margin-bottom:1.5rem;">
                <button onclick="window.location.href='crear_club.html'" 
                        style="padding:0.8rem 1.5rem; background:#0984e3; color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:700;">
                    Crear nuevo club
                </button>
            </div>
            <div id="clubesGrid" class="clubes-grid"></div>
        </section>

        <!-- Secci贸n Recomendaciones de libros -->
        <section>
            <div class="recomendaciones-section">
                <h2>Recomendaciones de Libros</h2>
                <div class="recomendaciones-row" id="recomendacionesGrid"></div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <p>驴Dese谩s m谩s informaci贸n de los clubes? Escribinos a <a href="mailto:mail@booksy.com">mail@booksy.com</a></p>
        <p class="footer-credits">Booksy &copy; 2025</p>
    </footer>

    <script>
        const API_URL = "http://127.0.0.1:5000";

        function logout() {
            localStorage.removeItem("username");
            localStorage.removeItem("role");
            window.location.href = "login.html";
        }

        async function cargarClubes() {
            const username = localStorage.getItem("username");
            const misClubesGrid = document.querySelector(".mis-clubes-grid");
            const clubesGrid = document.getElementById("clubesGrid");

            misClubesGrid.innerHTML = "";
            clubesGrid.innerHTML = "";

            try {
                const res = await fetch(`${API_URL}/clubs`);
                const data = await res.json();
                if (!data.success) return;

                data.clubs.forEach(club => {
                    const esMiembro = club.members.some(m => m.username === username);
                     const esCreador = club.ownerUsername === username; // <-- compara con el creador
                    const clubCard = document.createElement("div");
                    clubCard.className = "section-card club-card";
                      clubCard.innerHTML = `<div class="club-logo club-logo-default">
            <svg width="38" height="38" viewBox="0 0 38 38" fill="none">
                <rect x="4" y="8" width="13" height="22" rx="3" fill="#2c5a91"/>
                <rect x="21" y="8" width="13" height="22" rx="3" fill="#5fa8e9"/>
                            <rect x="18" y="8" width="2" height="22" fill="#e6eafc"/>
                        </svg>
                    </div>
                    <h3>${club.name}</h3>
                    <p>${club.description}</p>
                    ${esMiembro ? '<span style="color:#0984e3;font-weight:700;">Ya eres miembro</span>' : '<button class="unirme-btn">Unirme</button>'}
                    ${esCreador ? '<button class="editar-btn">Editar</button>' : ''}
                `;
                    if (esMiembro) {
        document.querySelector(".mis-clubes-grid").appendChild(clubCard);
        //  si soy miembro, al hacer click en toda la tarjeta voy al club
        clubCard.addEventListener("click", (e) => {
            // evitar que el click al bot贸n editar dispare la redirecci贸n
            if (!e.target.classList.contains("editar-btn")) {
                window.location.href = `club_lectura.html?clubId=${club.id}`;
            }
        });
    } else {
        document.getElementById("clubesGrid").appendChild(clubCard);
    }

                    if (!esMiembro) {
                        clubCard.querySelector(".unirme-btn").addEventListener("click", async () => {
            const joinRes = await fetch(`${API_URL}/joinClub`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ clubId: club.id, username })
            });
            const joinData = await joinRes.json();
            if (joinData.success) cargarClubes();
            else alert(joinData.message);
        });
                    }
                    if (esCreador) {
        clubCard.querySelector(".editar-btn").addEventListener("click", () => {
            window.location.href = `editar_club.html?clubId=${club.id}`;
        });
    }
                });
            } catch (error) {
                console.error("Error al cargar clubes:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const username = localStorage.getItem("username");
            const usernameDisplay = document.getElementById("usernameDisplay");

            if (username && usernameDisplay) {
                usernameDisplay.textContent = username;
            } else {
                window.location.href = "login.html";
            }

            cargarClubes();
            cargarLibrosRecomendados();

            // Dropdown funcionalidad
            const dropdownBtn = document.getElementById("profileDropdownBtn");
            const dropdownContent = document.getElementById("profileDropdownContent");
            if (dropdownBtn && dropdownContent) {
                dropdownBtn.addEventListener("mouseenter", () => { dropdownContent.style.display = "block"; });
                dropdownBtn.addEventListener("mouseleave", () => { setTimeout(() => { if (!dropdownContent.matches(':hover')) dropdownContent.style.display = "none"; }, 100); });
                dropdownContent.addEventListener("mouseleave", () => { dropdownContent.style.display = "none"; });
                dropdownContent.addEventListener("mouseenter", () => { dropdownContent.style.display = "block"; });
            }
        });

        async function cargarLibrosRecomendados() {
            const grid = document.getElementById("recomendacionesGrid");
            grid.innerHTML = "";
            try {
                const res = await fetch(`${API_URL}/books`);
                const data = await res.json();
                if (!data.success || !data.books) {
                    grid.innerHTML = '<p style="color:#636e72;">No hay libros recomendados.</p>';
                    return;
                }
                data.books.forEach(libro => {
                    const card = document.createElement("div");
                    card.className = "recomendacion-card";
                    card.innerHTML = `
                        <div style="width:100%;display:flex;justify-content:center;margin-bottom:10px;">
                            <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                                <rect x="8" y="12" width="16" height="28" rx="4" fill="#2c5a91"/>
                                <rect x="28" y="12" width="12" height="28" rx="4" fill="#5fa8e9"/>
                                <rect x="24" y="12" width="4" height="28" fill="#e6eafc"/>
                            </svg>
                        </div>
                        <h4>${libro.title}</h4>
                        <p>${libro.author ? libro.author : "Autor desconocido"}</p>
                    `;
                    grid.appendChild(card);
                });
            } catch (error) {
                grid.innerHTML = '<p style="color:#d63031;">Error al cargar libros.</p>';
            }
        }
        
    </script>
</body>
</html>
